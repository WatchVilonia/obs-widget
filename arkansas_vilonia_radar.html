<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arkansas & Vilonia Animated Weather Radar</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
            background-color: #f0f0f0; /* Optional: Set a background color */
        }
        /* Style for the timestamp display */
        #timestamp {
            position: absolute;
            bottom: 10px;
            right: 10px;
            padding: 5px 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: #ffffff;
            font-family: Arial, sans-serif;
            font-size: 14px;
            border-radius: 5px;
        }
    </style>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
    <div id="map"></div>
    <div id="timestamp">Loading...</div> <!-- Timestamp display -->

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        // Initialize the map without zoom controls
        let map = L.map('map', {
            center: [35.0834, -92.2071],
            zoom: 8,
            zoomControl: false // This removes the zoom controls
        });

        // Base map layer from OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 12,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Function to generate radar timestamps for the past 2 hours at 2-minute intervals
        function generateRadarTimestamps() {
            const timestamps = [];
            const now = Math.floor(Date.now() / (2 * 60 * 1000)) * (2 * 60 * 1000); // Round down to nearest 2 minutes
            for (let i = 60; i >= 0; i--) { // 61 frames (0 to 60)
                let time = now - (i * 2 * 60 * 1000);
                timestamps.push(Math.floor(time / 1000)); // Convert to UNIX timestamp in seconds
            }
            return timestamps;
        }

        // Generate radar timestamps
        const radarTimestamps = generateRadarTimestamps();

        // Array to hold the radar layers
        const radarLayers = [];

        // Variable to track how many layers have loaded
        let layersLoaded = 0;

        // Function to create radar layers
        function createRadarLayers() {
            radarTimestamps.forEach(function(timestamp, index) {
                let radarLayerUrlTemplate = `https://tilecache.rainviewer.com/v2/radar/${timestamp}/256/{z}/{x}/{y}/1/1_1.png`;

                let radarLayer = L.tileLayer(radarLayerUrlTemplate, {
                    opacity: 0, // Start with opacity 0
                    attribution: 'Weather data © RainViewer'
                });

                radarLayer.on('load', function() {
                    layersLoaded++;
                    if (layersLoaded === radarTimestamps.length) {
                        // All layers have loaded or attempted to load, start the animation
                        startAnimation();
                    }
                });

                radarLayer.on('tileerror', function() {
                    // Handle missing radar images by removing the layer
                    map.removeLayer(radarLayer);
                    radarLayers.splice(radarLayers.indexOf(radarLayer), 1);
                    layersLoaded++;
                    if (layersLoaded === radarTimestamps.length) {
                        // All layers have finished attempting to load
                        startAnimation();
                    }
                });

                radarLayers.push({
                    layer: radarLayer,
                    timestamp: timestamp
                });
                radarLayer.addTo(map);
            });
        }

        // Index to keep track of the current radar frame
        let radarIndex = 0;

        // Function to start the radar animation
        function startAnimation() {
            // If no layers are available, exit
            if (radarLayers.length === 0) {
                console.error('No radar layers available for animation.');
                document.getElementById('timestamp').innerText = 'No radar data available.';
                return;
            }

            // Function to update the frame
            function updateFrame() {
                // Set opacity of all layers to 0
                radarLayers.forEach(function(obj) {
                    obj.layer.setOpacity(0);
                });

                // Set opacity of current layer to desired opacity
                radarLayers[radarIndex].layer.setOpacity(0.6);

                // Update timestamp display
                let frameTime = new Date(radarLayers[radarIndex].timestamp * 1000);
                document.getElementById('timestamp').innerText = frameTime.toLocaleString();

                // Update index for next frame
                radarIndex = (radarIndex + 1) % radarLayers.length;
            }

            // Start the animation loop
            updateFrame(); // Show the first frame immediately
            setInterval(updateFrame, 200); // Change frame every 200 ms (adjust as needed)
        }

        // Start creating radar layers
        createRadarLayers();

        // Function to switch between Arkansas and Vilonia views
        function switchRadarView() {
            let currentCenter = map.getCenter();
            if (currentCenter.lat === 35.0834 && currentCenter.lng === -92.2071) {
                map.setView([35.0834, -92.1301], 11); // Vilonia view
            } else {
                map.setView([35.0834, -92.2071], 8); // Arkansas view
            }
        }

        // Cycle radar view every 30 seconds
        setInterval(switchRadarView, 30000);

    </script>
</body>
</html>
